<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Finan√ßas Pessoais</title>
    
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding-top: 20px;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Controles de M√™s */
        .month-selector {
            display: flex;
            gap: 5px;
            background-color: #e9ecef;
            padding: 5px;
            border-radius: 5px;
        }

        .month-selector button {
            background-color: #e9ecef;
            color: #495057;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .month-selector button:hover {
            background-color: #dee2e6;
        }

        .month-selector button.active {
            background-color: #007bff;
            color: white;
        }

        /* Bot√µes */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 4px;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* Layout de Pain√©is e Gr√°ficos */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid;
        }
        
        .panel-blue { border-left-color: #007bff; }
        .panel-green { border-left-color: #28a745; }
        .panel-red { border-left-color: #dc3545; }
        .panel-yellow { border-left-color: #ffc107; }
        .panel-purple { border-left-color: #6f42c1; } /* Novo para Investimentos */

        .panel h3 {
            margin-top: 0;
            font-size: 16px;
            color: #6c757d;
        }

        .panel p {
            font-size: 28px;
            font-weight: bold;
            margin: 5px 0 0;
        }

        .chart-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .chart-container h2 {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 15px;
        }

        /* Se√ß√µes de Formul√°rio */
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .form-section h2 {
            color: #495057;
            border-bottom: 1px dashed #ced4da;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .form-grid label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .form-grid input, .form-grid select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .full-width {
            grid-column: 1 / -1;
            text-align: right;
        }

        /* Tabelas */
        #tabela-gastos table {
            width: 100%;
            border-collapse: collapse;
        }

        #tabela-gastos th, #tabela-gastos td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #tabela-gastos th {
            background-color: #e9ecef;
            cursor: pointer;
            font-weight: bold;
            color: #495057;
            white-space: nowrap;
        }

        #tabela-gastos td span {
            display: block;
            min-width: 50px; /* Garante que campos edit√°veis n√£o sumam */
        }
        
        /* Estilo para Saldo L√≠quido no Painel */
        #saldo-liquido {
            transition: color 0.5s;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .dashboard-grid, .chart-section, .form-grid {
                grid-template-columns: 1fr;
            }
            .header-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .month-selector {
                width: 100%;
                justify-content: space-around;
                margin-top: 10px;
            }
            .dropdown {
                width: 100%;
                margin-top: 10px;
            }
            .dropdown-content {
                left: 0;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Dashboard de Controle Financeiro üí∏</h1>

        <div class="header-controls">
            <div id="month-selector" class="month-selector">
                </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary dropdown-toggle" type="button" id="import-csv-btn">
                    Importar Dados
                </button>
                <input type="file" id="file-input" accept=".csv" multiple style="display: none;">

                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle">
                        Exportar Dados üëá
                    </button>
                    <div class="dropdown-content">
                        <a id="save-current-month">Exportar M√™s Atual</a>
                        <a id="save-all-months">Exportar Todos os Meses</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="panel panel-green">
                <h3 id="titulo-saldo-liquido">Saldo L√≠quido (M√™s Atual)</h3>
                <p id="saldo-liquido">R$ 0,00</p>
            </div>
            <div class="panel panel-red">
                <h3 id="titulo-total-gastos">Total de Gastos (M√™s Atual)</h3>
                <p id="total-todos-meses">R$ 0,00</p>
            </div>
            <div class="panel panel-blue">
                <h3 id="titulo-total-receitas">Total de Receitas (M√™s Atual)</h3>
                <p id="total-receitas">R$ 0,00</p>
            </div>
             <div class="panel panel-purple">
                <h3>Total Investido (Acumulado)</h3>
                <p id="total-investido-acumulado">R$ 0,00</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="form-section">
                <h2>‚ûï Adicionar Despesa</h2>
                <form id="add-expense-form">
                    <div class="form-grid">
                        <label for="new-categoria">Categoria:</label>
                        <input type="text" id="new-categoria" required value="Outros">
                        
                        <label for="new-valor">Valor (R$):</label>
                        <input type="number" id="new-valor" step="0.01" required value="0">
                        
                        <label for="new-vencimento">Vencimento (Dia do M√™s):</label>
                        <input type="number" id="new-vencimento" min="1" max="31" required value="1">
                        
                        <label for="new-recorrencia">Recorr√™ncia:</label>
                        <select id="new-recorrencia" required>
                            <option value="Mensal">Mensal</option>
                            <option value="√önica">√önica</option>
                            <option value="Anual">Anual</option>
                        </select>
                        
                        <label for="new-tipo">Tipo de Gasto:</label>
                        <select id="new-tipo" required>
                            <option value="Essencial">Essencial</option>
                            <option value="N√£o Essencial">N√£o Essencial</option>
                        </select>

                        <label for="new-cartao">Tipo Pagamento:</label>
                        <select id="new-cartao" required>
                            <option value="Cart√£o">Cart√£o</option>
                            <option value="Pix">Pix</option>
                            <option value="Boleto">Boleto</option>
                            <option value="D√©bito Autom√°tico">D√©bito Autom√°tico</option>
                            <option value="Outros">Outros</option>
                        </select>

                        <div class="full-width">
                            <button type="submit" class="btn btn-red">Adicionar Despesa</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h2>‚ûï Adicionar Receita</h2>
                <form id="add-revenue-form">
                    <div class="form-grid">
                        <label for="new-rev-fonte">Fonte:</label>
                        <input type="text" id="new-rev-fonte" required value="Sal√°rio">
                        
                        <label for="new-rev-valor">Valor (R$):</label>
                        <input type="number" id="new-rev-valor" step="0.01" required value="0">
                        
                        <label for="new-rev-status">Status:</label>
                        <select id="new-rev-status" required>
                            <option value="Recebido">Recebido</option>
                            <option value="Pendente">Pendente</option>
                        </select>
                        
                        <label for="new-rev-recorrencia">Recorr√™ncia:</label>
                        <select id="new-rev-recorrencia" required>
                            <option value="Mensal">Mensal</option>
                            <option value="√önica">√önica</option>
                        </select>

                        <div class="full-width">
                            <button type="submit" class="btn btn-green">Adicionar Receita</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="form-section">
            <h2>üí∞ Adicionar Aporte/Investimento</h2>
            <form id="add-investment-form">
                <div class="form-grid">
                    <label for="new-inv-banco">Banco/Corretora:</label>
                    <input type="text" id="new-inv-banco" required value="XP">

                    <label for="new-inv-valor">Valor Aportado (R$):</label>
                    <input type="number" id="new-inv-valor" step="0.01" required value="0">
                    
                    <label for="new-inv-ativo">Tipo de Ativo:</label>
                    <select id="new-inv-ativo" required>
                        <option value="A√ß√µes">A√ß√µes</option>
                        <option value="Tesouro Selic">Tesouro Selic</option>
                        <option value="CDB">CDB</option>
                        <option value="LCI">LCI</option>
                        <option value="LCA">LCA</option>
                        <option value="Outros">Outros</option>
                    </select>

                    <div class="full-width">
                        <button type="submit" class="btn btn-purple" style="background-color: #6f42c1;">Registrar Aporte</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="chart-container" style="grid-column: 1 / -1; margin-bottom: 20px;">
            <h2 id="titulo-evolucao-mensal">üìà Evolu√ß√£o de Gastos Mensais (Ano Atual)</h2>
            <div id="grafico-evolucao-mensal"></div>
        </div>
        
        <div class="chart-container" style="grid-column: 1 / -1; margin-bottom: 20px;">
            <h2>üìä Evolu√ß√£o do Saldo Total Acumulado em Investimentos</h2>
            <div id="grafico-evolucao-investimentos"></div>
        </div>

        <div class="chart-section">
            <div class="chart-container">
                <h2 id="titulo-essencial">Essencial vs. N√£o Essencial</h2>
                <div id="grafico-essencial"></div>
            </div>
            <div class="chart-container">
                <h2 id="titulo-pagamento">Meio de Pagamento</h2>
                <div id="grafico-pagamento"></div>
            </div>
            <div class="chart-container" style="grid-column: 1 / -1;">
                <h2>Propor√ß√£o por Categoria de Gasto</h2>
                <div id="grafico-categoria"></div>
            </div>
            <div class="chart-container">
                <h2>Distribui√ß√£o de Investimentos por Tipo de Ativo</h2>
                <div id="grafico-investimentos-distribuicao"></div>
            </div>
            <div class="dashboard-grid" style="grid-column: 2 / 2; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <div class="panel panel-yellow" style="border-left-color: orange;">
                    <h3>Cart√£o (M√™s)</h3>
                    <p id="total-cartao">R$ 0,00</p>
                </div>
                 <div class="panel panel-yellow">
                    <h3>D√©bito Autom√°tico</h3>
                    <p id="total-debito">R$ 0,00</p>
                </div>
                <div class="panel panel-yellow">
                    <h3>Pix/Boleto</h3>
                    <p id="total-pix">R$ 0,00</p>
                </div>
                 <div class="panel panel-yellow" style="border-left-color: purple;">
                    <h3>Total Pago</h3>
                    <p id="total-pago">R$ 0,00</p>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>üìù Tabela de Receitas e Aportes (M√™s Atual)</h2>
            <div id="receitas-list">
                </div>
        </div>

        <div class="form-section">
            <h2>üìù Tabela de Despesas (M√™s Atual)</h2>
            <div id="tabela-gastos">
                </div>
        </div>

    </div> <script>
        // --- VARI√ÅVEIS DE ESTADO ---
        let rawData = []; // Armazena dados de despesas de TODOS os meses
        let rawRevenues = []; // Armazena dados de receitas de TODOS os meses
        
        // VARI√ÅVEL DE INVESTIMENTOS (Acumulado) com o campo tipo_ativo
        let rawInvestments = [
            // Dados de exemplo atualizados com tipo_ativo
            { id: 1, banco: 'XP', valor_aplicado: 4000.00, tipo_ativo: 'A√ß√µes', data: '10/2025', novo_aporte: 0, mes: 10 },
            { id: 2, banco: 'XP', valor_aplicado: 6000.00, tipo_ativo: 'Tesouro Selic', data: '10/2025', novo_aporte: 0, mes: 10 },
            { id: 3, banco: 'Inter', valor_aplicado: 5000.00, tipo_ativo: 'CDB', data: '10/2025', novo_aporte: 0, mes: 10 },
            { id: 4, banco: 'Nubank', valor_aplicado: 3000.00, tipo_ativo: 'LCI', data: '10/2025', novo_aporte: 0, mes: 10 },
            
            { id: 5, banco: 'XP', valor_aplicado: 4100.00, tipo_ativo: 'A√ß√µes', data: '11/2025', novo_aporte: 100, mes: 11 },
            { id: 6, banco: 'XP', valor_aplicado: 6200.00, tipo_ativo: 'Tesouro Selic', data: '11/2025', novo_aporte: 200, mes: 11 },
            { id: 7, banco: 'Inter', valor_aplicado: 5000.00, tipo_ativo: 'CDB', data: '11/2025', novo_aporte: 0, mes: 11 },
            { id: 8, banco: 'Nubank', valor_aplicado: 3200.00, tipo_ativo: 'LCI', data: '11/2025', novo_aporte: 200, mes: 11 }
        ]; 
        
        // Adicionando um aporte negativo para refletir um investimento j√° realizado em 11/2025 (simulando Saldo L√≠quido)
        rawRevenues.push({ id: 99999, fonte: 'APORTE: XP - Tesouro Selic', valor: -200, status: 'Aportado', recorrencia: '√önica', mes: 11 });
        rawRevenues.push({ id: 99998, fonte: 'APORTE: XP - A√ß√µes', valor: -100, status: 'Aportado', recorrencia: '√önica', mes: 11 });
        rawRevenues.push({ id: 99997, fonte: 'APORTE: Nubank - LCI', valor: -200, status: 'Aportado', recorrencia: '√önica', mes: 11 });
    
    
        let sortedData = [];
        let totalMonthlyExpenses = 0; 
        let totalReceivedRevenue = 0; // Receitas positivas recebidas
        
        const today = new Date();
        let currentMonth = today.getMonth() + 1; 
        
        const CURRENT_YEAR = today.getFullYear(); 
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const MONTH_NAMES_SHORT = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        
        let currentSortColumn = 'vencimento';
        let currentSortDirection = 1;
    
        const EXPENSE_COLUMN_NAMES = {
            'categoria': 'Categoria', 'vencimento': 'Vencimento (Dia do M√™s)', 'valor': 'Valor (R$)',
            'status': 'Status', 'recorrencia': 'Recorr√™ncia', 'tipo_gasto': 'Tipo de Gasto',
            'observacao': 'Observa√ß√£o', 'cartao': 'Tipo Pagamento', 'mes': 'M√™s' 
        };
        const REVENUE_COLUMN_NAMES = {
            'fonte': 'Fonte', 'valor': 'Valor (R$)', 'status': 'Status', 'recorrencia': 'Recorr√™ncia', 'mes': 'M√™s' 
        };
        const INVESTMENT_COLUMN_NAMES = {
            'banco': 'Banco', 'tipo_ativo': 'Tipo de Ativo', 'valor_aplicado': 'Valor Aplicado (R$)', 
            'novo_aporte': 'Novo Aporte (R$)', 'data': 'Data (MM/AAAA)', 'mes': 'M√™s'
        };
    
        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // Eventos para o Dropdown Salvar
            document.getElementById('save-current-month').addEventListener('click', (e) => {
                e.preventDefault();
                saveCurrentMonthData();
            });
            document.getElementById('save-all-months').addEventListener('click', (e) => {
                e.preventDefault();
                saveAllData(); 
            });
            
            // CORRE√á√ÉO: L√≥gica para o bot√£o "Importar Dados"
            const importButton = document.getElementById('import-csv-btn');
            const fileInput = document.getElementById('file-input');
            
            if (importButton && fileInput) {
                importButton.addEventListener('click', () => fileInput.click()); 
                
                fileInput.addEventListener('change', (event) => {
                    // Reinicia os dados globais para importar novos arquivos
                    rawData = []; 
                    rawRevenues = []; 
                    rawInvestments = []; 
                    
                    processSelectedFiles(event.target.files);
                });
            }
            
            document.getElementById('add-expense-form').addEventListener('submit', addExpense);
            document.getElementById('add-revenue-form').addEventListener('submit', addRevenue); 
            document.getElementById('add-investment-form').addEventListener('submit', addInvestment); 
            
            setupMonthSelector(); 
            setupEventDelegation(); 
            processData(); 
        });
        
        // --- FUN√á√ïES DE UTILIDADE ---
        function cleanCurrency(value) {
            if (typeof value === 'string' && value.trim() !== '') {
                let cleanValue = value.replace(/R\$/g, '').replace(/\$/g, '').replace(/\./g, '').replace(/,/g, '.').trim();
                return parseFloat(cleanValue) || 0; 
            }
            if (typeof value === 'number') return value;
            return 0;
        }
        function formatCurrency(value) {
             return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        function formatPercent(value) {
            if (typeof value === 'number' && !isNaN(value)) {
                return value.toFixed(1) + '%';
            }
            return '0.0%';
        }
        function capitalize(s) {
            if (typeof s !== 'string') return s;
            s = s.toLowerCase().trim();
            
            if (s === 'nao essencial') return 'N√£o Essencial';
            if (s === 'debito automatico' || s === 'debitoautomatico') return 'D√©bito Autom√°tico';
            if (s === 'unica') return '√önica';
            if (s === 'recebido') return 'Recebido';
            if (s === 'pendente') return 'Pendente';
            if (s === 'cartao') return 'Cart√£o';
            if (s === 'pix') return 'Pix';
            if (s === 'boleto') return 'Boleto';
            if (s === 'outros') return 'Outros';
            if (s.startsWith('aporte:')) return s.toUpperCase(); // Mant√©m aportes em mai√∫sculo
            
            return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
        }
        
        // --- FUN√á√ÉO PARA O SELETOR DE M√äS ---
        function setupMonthSelector() {
            const selectorDiv = document.getElementById('month-selector');
            let html = '';
            for (let i = 1; i <= 12; i++) {
                const isActive = i === currentMonth ? 'active' : '';
                html += `<button class="${isActive}" onclick="filterByMonth(${i})">${MONTH_NAMES_SHORT[i - 1]}</button>`;
            }
            selectorDiv.innerHTML = html;
        }
    
        function filterByMonth(month) {
            if (month < 1 || month > 12 || month === currentMonth) return;
            
            currentMonth = month;
            
            const buttons = document.querySelectorAll('.month-selector button');
            buttons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.month-selector button:nth-child(${month})`).classList.add('active');
            
            processData(); 
        }
        
        // --- L√ìGICA DE EDI√á√ÉO/DELE√á√ÉO DA TABELA ---
        function makeEditable(element, id, column, type, isRevenue = false) {
            const oldValue = element.textContent;
            element.contentEditable = true;
            element.focus();
    
            function saveNewValue(e) {
                if (e && e.key === 'Enter') {
                    e.preventDefault(); 
                }
    
                let newValue = element.textContent;
                
                const dataArray = isRevenue ? rawRevenues : rawData;
                const itemIndex = dataArray.findIndex(item => item.id === id);
    
                if (itemIndex === -1) {
                    console.error("Item n√£o encontrado.");
                    element.contentEditable = false;
                    processData(); 
                    return;
                }
    
                if (type === 'number') {
                    newValue = cleanCurrency(newValue);
                } else {
                    newValue = capitalize(newValue);
                }
                
                // Tratamento especial para o M√™s (deve ser entre 1 e 12)
                if (column === 'mes') {
                    newValue = parseInt(newValue);
                    if (isNaN(newValue) || newValue < 1 || newValue > 12) {
                        alert("M√™s deve ser um n√∫mero entre 1 e 12.");
                        element.textContent = oldValue;
                        element.contentEditable = false;
                        return;
                    }
                }
    
                dataArray[itemIndex][column] = newValue;
                
                element.contentEditable = false;
                processData(); 
            }
    
            element.addEventListener('blur', saveNewValue);
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveNewValue(e);
                }
            });
        }
    
        function deleteItem(id, isRevenue = false) {
            if (!confirm(`Tem certeza que deseja deletar este item (ID: ${id})?`)) {
                return;
            }
            
            const dataArray = isRevenue ? rawRevenues : rawData;
            const itemToDelete = dataArray.find(item => item.id === id);
            
            // NOVO: L√≥gica especial para deletar entradas de aporte
            if (isRevenue && itemToDelete && itemToDelete.status === 'Aportado') {
                 const valorAporte = itemToDelete.valor * -1; // Valor positivo do aporte
                 const aporteSource = itemToDelete.fonte.replace('APORTE: ', '');
                 
                 // 1. Tenta achar o investimento correspondente
                 const invIndex = rawInvestments.findIndex(i => 
                     i.mes === itemToDelete.mes && 
                     i.novo_aporte === valorAporte && 
                     `${i.banco} - ${i.tipo_ativo}` === aporteSource
                 );
                 
                 // Se encontrou, reduz o aporte
                 if (invIndex !== -1) {
                    rawInvestments[invIndex].novo_aporte -= valorAporte;
                    rawInvestments[invIndex].valor_aplicado -= valorAporte;
                    
                    // Se o valor aplicado zerar ou ficar negativo, remove o registro
                    if (rawInvestments[invIndex].valor_aplicado <= 0) {
                         rawInvestments.splice(invIndex, 1);
                    }
                 }
            }
    
            if (isRevenue) {
                rawRevenues = rawRevenues.filter(item => item.id !== id);
            } else {
                rawData = rawData.filter(item => item.id !== id);
            }
            processData();
        }
    
        function setupEventDelegation() {
            document.getElementById('tabela-gastos').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.dataset.id);
                    deleteItem(id, e.target.dataset.type === 'revenue');
                }
            });
            document.getElementById('receitas-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.dataset.id);
                    deleteItem(id, e.target.dataset.type === 'revenue');
                }
            });
        }
        
        // --- FUN√á√ïES DE ADI√á√ÉO DE DADOS ---
        function addExpense(event) {
            event.preventDefault();
            
            const maxId = rawData.length > 0 ? Math.max(...rawData.map(d => d.id)) : 0;
            
            const newExpense = {
                id: maxId + 1,
                categoria: capitalize(document.getElementById('new-categoria').value),
                valor: parseFloat(document.getElementById('new-valor').value) || 0,
                vencimento: parseInt(document.getElementById('new-vencimento').value) || 1,
                status: 'Pendente', 
                recorrencia: capitalize(document.getElementById('new-recorrencia').value),
                tipo_gasto: capitalize(document.getElementById('new-tipo').value),
                observacao: '',
                cartao: capitalize(document.getElementById('new-cartao').value),
                mes: currentMonth
            };
    
            if (newExpense.valor <= 0) {
                alert("O valor da despesa deve ser maior que zero.");
                return;
            }
    
            rawData.push(newExpense);
            document.getElementById('add-expense-form').reset();
            processData();
        }
        
        function addRevenue(event) {
            event.preventDefault();
            
            const maxId = rawRevenues.length > 0 ? Math.max(...rawRevenues.map(d => d.id)) : 0;
            
            const newRevenue = {
                id: maxId + 1,
                fonte: capitalize(document.getElementById('new-rev-fonte').value),
                valor: parseFloat(document.getElementById('new-rev-valor').value) || 0,
                status: capitalize(document.getElementById('new-rev-status').value),
                recorrencia: capitalize(document.getElementById('new-rev-recorrencia').value),
                mes: currentMonth
            };
            
            if (newRevenue.valor <= 0) {
                alert("O valor da receita deve ser maior que zero.");
                return;
            }
    
            rawRevenues.push(newRevenue);
            document.getElementById('add-revenue-form').reset();
            processData();
        }
    
        // Fun√ß√£o para adicionar investimento (AGORA INTEGRA SALDO L√çQUIDO E TIPO DE ATIVO)
        function addInvestment(event) {
            event.preventDefault();
            
            const valorAporte = parseFloat(document.getElementById('new-inv-valor').value) || 0;
            const banco = document.getElementById('new-inv-banco').value;
            const tipoAtivo = document.getElementById('new-inv-ativo').value; 
            
            const currentSaldoLiquido = calculateCurrentSaldoLiquido(); 
    
            if (valorAporte <= 0) {
                alert('O valor do aporte deve ser maior que zero.');
                return;
            }
    
            // L√≥gica de Checagem do Saldo L√≠quido
            if (valorAporte > currentSaldoLiquido) {
                if (!confirm(`O aporte de ${formatCurrency(valorAporte)} √© maior que o Saldo L√≠quido dispon√≠vel de ${formatCurrency(currentSaldoLiquido)}. Deseja continuar e deixar o Saldo L√≠quido Negativo?`)) {
                    return;
                }
            }
            
            // 1. Encontra o ID m√°ximo
            const maxId = rawInvestments.length > 0 ? Math.max(...rawInvestments.map(d => d.id)) : 0;
            
            // 2. Encontra o √∫ltimo valor acumulado desse BANCO E ATIVO
            const lastInvestment = rawInvestments
                .filter(i => i.banco === banco && i.tipo_ativo === tipoAtivo) 
                .sort((a, b) => {
                     const dateA = new Date(a.data.split('/')[1], a.data.split('/')[0] - 1);
                     const dateB = new Date(b.data.split('/')[1], b.data.split('/')[0] - 1);
                     return dateA - dateB;
                })
                .pop();
            
            // 3. Verifica se o m√™s atual j√° tem registro desse BANCO E ATIVO. Se sim, APENAS ATUALIZA
            const existingEntryIndex = rawInvestments.findIndex(i => i.mes === currentMonth && i.banco === banco && i.tipo_ativo === tipoAtivo);
    
            if (existingEntryIndex !== -1) {
                // Se j√° existe um registro para o m√™s/banco/ativo, apenas atualiza
                rawInvestments[existingEntryIndex].valor_aplicado += valorAporte;
                rawInvestments[existingEntryIndex].novo_aporte += valorAporte;
                
            } else {
                // Sen√£o, cria uma nova entrada, baseada no saldo anterior
                const lastAccumulated = (lastInvestment) ? lastInvestment.valor_aplicado : 0;
                
                const monthStr = String(currentMonth).padStart(2, '0');
                
                const newInvestment = {
                    id: maxId + 1,
                    banco: banco,
                    tipo_ativo: tipoAtivo, 
                    valor_aplicado: lastAccumulated + valorAporte, // Saldo anterior + novo aporte
                    data: `${monthStr}/${CURRENT_YEAR}`,
                    novo_aporte: valorAporte,
                    mes: currentMonth
                };
                rawInvestments.push(newInvestment);
            }
            
            // Registra este aporte como um "gasto" no Saldo L√≠quido do m√™s atual
            const maxRevId = rawRevenues.length > 0 ? Math.max(...rawRevenues.map(d => d.id)) : 0;
            rawRevenues.push({
                 id: maxRevId + 1,
                 fonte: `APORTE: ${banco} - ${tipoAtivo}`,
                 valor: -valorAporte, // Valor negativo para abater do Saldo L√≠quido
                 status: 'Aportado',
                 recorrencia: '√önica',
                 mes: currentMonth
            });
            
            document.getElementById('add-investment-form').reset();
            processData(); 
        }
        
        // Fun√ß√£o para calcular o Saldo L√≠quido em tempo real
        function calculateCurrentSaldoLiquido() {
             const totalGastosMesSelecionado = rawData
                .filter(d => parseInt(d.mes) === currentMonth)
                .reduce((sum, d) => sum + d.valor, 0);
    
             // Total de Receitas Recebidas (apenas status 'Recebido' e valor > 0)
             const totalReceitasRecebidas = rawRevenues
                .filter(r => parseInt(r.mes) === currentMonth && r.status === 'Recebido' && r.valor > 0)
                .reduce((sum, r) => sum + r.valor, 0);
                
             // Aportes realizados (soma os valores negativos do status 'Aportado')
             const aportesDebito = rawRevenues
                .filter(r => parseInt(r.mes) === currentMonth && r.status === 'Aportado')
                .reduce((sum, r) => sum + r.valor, 0);
    
             // Saldo L√≠quido = Receitas Recebidas - Gastos Projetados + Aportes (que s√£o negativos)
             return totalReceitasRecebidas - totalGastosMesSelecionado + aportesDebito;
        }
    
    
        // --- FUN√á√ïES DE IMPORTA√á√ÉO E PROCESSAMENTO CSV ---
        function processSelectedFiles(files) {
            let filesProcessed = 0;
            const totalFiles = files.length;
            
            if (totalFiles === 0) return;
    
            Array.from(files).forEach(file => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    delimiter: ";", 
                    complete: (results) => {
                        const data = results.data;
                        const headers = results.meta.fields || [];
    
                        // Verifica se o arquivo √© de Despesas
                        if (headers.includes(EXPENSE_COLUMN_NAMES.categoria)) {
                            processImportedData(data, rawData, EXPENSE_COLUMN_NAMES, 'despesa');
                        }
                        // Verifica se o arquivo √© de Receitas
                        else if (headers.includes(REVENUE_COLUMN_NAMES.fonte)) {
                            processImportedData(data, rawRevenues, REVENUE_COLUMN_NAMES, 'receita');
                        }
                        // Verifica se o arquivo √© de Investimentos
                        else if (headers.includes(INVESTMENT_COLUMN_NAMES.banco) && headers.includes(INVESTMENT_COLUMN_NAMES.tipo_ativo)) {
                            processImportedData(data, rawInvestments, INVESTMENT_COLUMN_NAMES, 'investimento');
                        }
                        
                        filesProcessed++;
                        if (filesProcessed === totalFiles) {
                            alert(`Importa√ß√£o conclu√≠da. ${totalFiles} arquivo(s) processado(s).`);
                            processData();
                        }
                    },
                    error: (error) => {
                        console.error("Erro ao analisar o arquivo:", file.name, error);
                        filesProcessed++;
                        if (filesProcessed === totalFiles) {
                             processData();
                        }
                    }
                });
            });
        }
    
        function processImportedData(data, targetArray, columnMap, type) {
            
            const reverseColumnMap = {};
            for (const key in columnMap) {
                reverseColumnMap[columnMap[key]] = key;
            }
    
            const maxId = targetArray.length > 0 ? Math.max(...targetArray.map(d => d.id)) : 0;
            let currentMaxId = maxId;
    
            data.forEach(row => {
                const newEntry = { id: ++currentMaxId };
                let isValid = true;
    
                for (const header in row) {
                    const internalKey = reverseColumnMap[header];
                    if (internalKey) {
                        let value = row[header];
                        
                        // Tratamento de convers√£o de tipos
                        if (internalKey === 'valor' || internalKey === 'valor_aplicado' || internalKey === 'novo_aporte') {
                            value = cleanCurrency(value);
                        } else if (internalKey === 'vencimento' || internalKey === 'mes') {
                            value = parseInt(value) || 1;
                        } else {
                            value = String(value).trim();
                            if (type !== 'investimento') {
                                 value = capitalize(value);
                            }
                        }
                        
                        newEntry[internalKey] = value;
                    }
                }
                
                if (isValid && (type === 'despesa' || type === 'receita') && newEntry.valor !== undefined) {
                     targetArray.push(newEntry);
                } else if (isValid && type === 'investimento' && newEntry.valor_aplicado !== undefined) {
                     targetArray.push(newEntry);
                }
            });
            
        }
        // --- PROCESSAMENTO CENTRAL (Com Filtro Mensal) ---
    function processData() {
        
        // Filtra despesas pelo m√™s atual
        const filteredExpenses = rawData.filter(d => parseInt(d.mes) === currentMonth);
        
        // Filtra receitas pelo m√™s atual (inclui Receitas e Aportes)
        const filteredRevenues = rawRevenues.filter(r => parseInt(r.mes) === currentMonth); 
        
        // Calcula o total do m√™s (excluindo anuais) para o SUM√ÅRIO de Gastos
        const monthlyData = filteredExpenses.filter(d => {
            const recurrence = String(d.recorrencia || '').toLowerCase().trim();
            return recurrence !== 'anual';
        });
        
        totalMonthlyExpenses = monthlyData.reduce((sum, d) => sum + d.valor, 0);
        
        // Renderiza receitas/aportes do m√™s selecionado e atualiza totalReceivedRevenue (apenas receitas positivas)
        renderRevenues(filteredRevenues); 
        
        const totalReceitas = totalReceivedRevenue; 

        // Ordena os dados filtrados para a tabela
        sortedData = [...filteredExpenses] 
            .sort((a, b) => {
                let result = 0;
                
                const calculatePercent = (value, total) => (total > 0) ? (value / total) : 0;
                
                if (currentSortColumn === 'percentual') {
                    const aRecurrence = String(a.recorrencia).toLowerCase().trim();
                    const bRecurrence = String(b.recorrencia).toLowerCase().trim();
                    
                    const aValue = aRecurrence !== 'anual' ? a.valor : 0;
                    const bValue = bRecurrence !== 'anual' ? b.valor : 0;

                    const aPercent = calculatePercent(aValue, totalMonthlyExpenses);
                    const bPercent = calculatePercent(bValue, totalMonthlyExpenses);
                    result = aPercent - bPercent;
                    
                } else if (currentSortColumn === 'participacao_receita') {
                     const aPercent = calculatePercent(a.valor, totalReceitas);
                     const bPercent = calculatePercent(b.valor, totalReceitas);
                     result = aPercent - bPercent;
                }
                else {
                    let aVal = a[currentSortColumn];
                    let bVal = b[currentSortColumn];
                    
                    if (currentSortColumn === 'valor' || currentSortColumn === 'vencimento') {
                         result = aVal - bVal;
                    } else {
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                        if (aVal < bVal) result = -1;
                        if (aVal > bVal) result = 1;
                    }
                }
                
                return result * currentSortDirection; 
            });

        processInvestments(); 
        
        renderDashboard();
    }

    // --- RENDERIZA√á√ÉO DE RECEITAS (AJUSTADA PARA INCLUIR APORTES) ---
    function renderRevenues(filteredRevenues) {
        const listDiv = document.getElementById('receitas-list');
        listDiv.innerHTML = ''; 
        
        if (filteredRevenues.length === 0) {
            listDiv.innerHTML = '<p>Nenhuma receita ou aporte registrado para este m√™s.</p>';
            totalReceivedRevenue = 0;
            return;
        }

        let html = '<table style="width:100%; border-collapse: collapse;"><thead><tr>';
        
        const headers = ['Fonte', 'Valor (R$)', 'Status', 'Recorr√™ncia', 'M√™s', 'A√ß√£o'];
        const keys = ['fonte', 'valor', 'status', 'recorrencia', 'mes'];
        
        headers.forEach(header => {
            html += `<th style="padding: 8px; border-bottom: 2px solid #ccc; text-align: left; font-size: 14px; background-color: #f8f8f8;">${header}</th>`;
        });
        html += '</tr></thead><tbody>';

        let totalRecebidoPositivo = 0;

        filteredRevenues.forEach(item => {
            
            // S√≥ soma no total de receitas POSITIVAS
            if (item.valor > 0 && item.status === 'Recebido') {
                totalRecebidoPositivo += item.valor;
            }
            
            // Estilo para destacar aportes (debito)
            const rowStyle = item.valor < 0 ? 'background-color: #ffe6e6; color: #dc3545;' : ''; 

            html += `<tr style="${rowStyle}">`;
            keys.forEach(key => {
                let displayValue = item[key];
                let type = 'text';

                if (key === 'valor') {
                    displayValue = formatCurrency(item.valor);
                    type = 'number';
                }
                
                // Aportes n√£o devem ser edit√°veis
                const canEdit = item.status !== 'Aportado';

                html += `<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 14px;">
                    <span 
                        ${canEdit ? `onclick="makeEditable(this, ${item.id}, '${key}', '${type}', true)"` : ''}
                    >
                        ${displayValue}
                    </span>
                </td>`;
            });
            html += `<td style="padding: 8px; border-bottom: 1px solid #eee;">
                <button class="delete-btn" data-id="${item.id}" data-type="revenue" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">X</button>
            </td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        listDiv.innerHTML = html;
        totalReceivedRevenue = totalRecebidoPositivo;
        document.getElementById('total-receitas').textContent = formatCurrency(totalReceivedRevenue);
    }
    
    // Fun√ß√£o para processar e renderizar Investimentos
    function processInvestments() {
             
         // 1. Calcula o total ACUMULADO de investimento no M√äS ATUAL (agrupando por Banco e Ativo)
         const monthlyInvestments = rawInvestments
            .filter(i => parseInt(i.mes) === currentMonth)
            .reduce((acc, current) => {
                const key = `${current.banco}_${current.tipo_ativo}`;
                acc[key] = Math.max(acc[key] || 0, current.valor_aplicado);
                return acc;
            }, {});

        // 2. Se n√£o houver dados no m√™s atual, busca o √∫ltimo registro do m√™s anterior
        if (Object.keys(monthlyInvestments).length === 0 && rawInvestments.length > 0) {
            
            const lastAvailableMonth = rawInvestments.reduce((maxMonth, item) => Math.max(maxMonth, item.mes), 0);
            
            rawInvestments
                .filter(i => parseInt(i.mes) === lastAvailableMonth)
                .reduce((acc, current) => {
                    const key = `${current.banco}_${current.tipo_ativo}`;
                    monthlyInvestments[key] = Math.max(monthlyInvestments[key] || 0, current.valor_aplicado);
                    return acc;
                }, {});
        }
        
         // 3. Calcula o Total Geral Acumulado no m√™s
         const totalAcumulado = Object.values(monthlyInvestments).reduce((sum, val) => sum + val, 0);

         // 4. Renderiza o sum√°rio e o gr√°fico de distribui√ß√£o
         document.getElementById('total-investido-acumulado').textContent = formatCurrency(totalAcumulado);
         renderInvestmentDistributionChart(monthlyInvestments, totalAcumulado);
         renderInvestmentEvolutionChart();
    }


    function renderDashboard() {
        const monthName = MONTH_NAMES[currentMonth - 1]; 

        document.getElementById('titulo-essencial').textContent = `Essencial vs. N√£o Essencial (${monthName})`;
        document.getElementById('titulo-pagamento').textContent = `Meio de Pagamento (${monthName})`;
        document.getElementById('titulo-evolucao-mensal').textContent = `üìà Evolu√ß√£o de Gastos Mensais (Ano Atual) - M√™s Atual: ${monthName}`;
        document.getElementById('titulo-total-receitas').textContent = `Total de Receitas (${monthName})`;
        document.getElementById('titulo-saldo-liquido').textContent = `Saldo L√≠quido (${monthName})`;
        document.getElementById('titulo-total-gastos').textContent = `Total de Gastos (${monthName})`;


        const monthlyData = rawData.filter(d => {
            const recurrence = String(d.recorrencia || '').toLowerCase().trim();
            return parseInt(d.mes) === currentMonth && recurrence !== 'anual';
        });
        
        const totalMensal = totalMonthlyExpenses;
        const totalPago = monthlyData.filter(d => String(d.status || '').toLowerCase().trim() === 'pago').reduce((sum, d) => sum + d.valor, 0);
        
        const totalCartao = monthlyData.filter(d => String(d.cartao || '').toLowerCase().trim() === 'cartao').reduce((sum, d) => sum + d.valor, 0);
        const totalDebito = monthlyData.filter(d => String(d.cartao || '').toLowerCase().trim() === 'd√©bito autom√°tico').reduce((sum, d) => sum + d.valor, 0);
        const totalPixBoleto = monthlyData.filter(d => {
            const cartao = String(d.cartao || '').toLowerCase().trim();
            return cartao === 'pix' || cartao === 'boleto';
        }).reduce((sum, d) => sum + d.valor, 0);
        
        
        const totalGastosMesSelecionado = rawData.filter(d => parseInt(d.mes) === currentMonth).reduce((sum, d) => sum + d.valor, 0);

        const totalReceitas = totalReceivedRevenue; 
        const saldoLiquido = calculateCurrentSaldoLiquido(); 
        
        document.getElementById('total-mensal').textContent = formatCurrency(totalMensal); // N√£o √© usado em painel mas √© √∫til
        document.getElementById('total-pago').textContent = formatCurrency(totalPago);
        document.getElementById('total-cartao').textContent = formatCurrency(totalCartao);
        
        document.getElementById('total-debito').textContent = formatCurrency(totalDebito);
        document.getElementById('total-pix').textContent = formatCurrency(totalPixBoleto);
        document.getElementById('total-outros').textContent = formatCurrency(totalGastosMesSelecionado - totalCartao - totalDebito - totalPixBoleto); // Simplificado para mostrar o que falta

        document.getElementById('total-todos-meses').textContent = formatCurrency(totalGastosMesSelecionado); 
        
        document.getElementById('saldo-liquido').textContent = formatCurrency(saldoLiquido);
        document.getElementById('saldo-liquido').style.color = saldoLiquido >= 0 ? '#28a745' : '#dc3545';

        renderMonthlyEvolutionChart(); 
        renderEssencialChart(monthlyData);
        renderPaymentMethodChart(monthlyData); 
        renderCategoryProportionChart(monthlyData);
        
        renderTable(sortedData, totalReceitas); 
    }
    // --- RENDERIZA√á√ÉO DA TABELA DE DESPESAS ---
    function renderTable(data, totalReceitas) {
        const tableDiv = document.getElementById('tabela-gastos');
        tableDiv.innerHTML = '';
        
        if (data.length === 0) {
            tableDiv.innerHTML = '<p>Nenhuma despesa registrada para o m√™s selecionado.</p>';
            return;
        }

        let html = '<table style="width:100%; border-collapse: collapse; margin-top: 10px;"><thead><tr>';

        const headers = [
            'Categoria', 'Vencimento', 'Valor (R$)', 'Status', 'Tipo Pagamento', 
            'Recorr√™ncia', 'Tipo Gasto', 'Observa√ß√£o', 'M√™s', '% Mensal', 
            '% Receita', 'A√ß√£o'
        ];
        const keys = [
            'categoria', 'vencimento', 'valor', 'status', 'cartao', 
            'recorrencia', 'tipo_gasto', 'observacao', 'mes', 'percentual', 
            'participacao_receita'
        ];
        
        headers.forEach((header, index) => {
            const sortKey = (index < keys.length) ? keys[index] : null;
            let sortIndicator = '';
            
            if (sortKey && sortKey === currentSortColumn) {
                sortIndicator = currentSortDirection === 1 ? ' ‚ñ≤' : ' ‚ñº';
            }

            if (sortKey) {
                html += `<th 
                    onclick="sortTableBy('${sortKey}')" 
                    style="cursor: pointer; padding: 10px; border-bottom: 2px solid #ccc; text-align: left; background-color: #f8f8f8; font-size: 14px; white-space: nowrap;"
                >
                    ${header}${sortIndicator}
                </th>`;
            } else {
                html += `<th style="padding: 10px; border-bottom: 2px solid #ccc; text-align: left; background-color: #f8f8f8; font-size: 14px; white-space: nowrap;">${header}</th>`;
            }
        });
        
        html += '</tr></thead><tbody>';

        data.forEach(item => {
            const isPago = item.status === 'Pago';
            const isAnual = item.recorrencia === 'Anual';
            
            let rowStyle = '';
            if (isPago) {
                rowStyle += 'background-color: #e6ffe6;'; 
            } else if (isAnual) {
                 rowStyle += 'background-color: #fff9e6;'; 
            }
            
            html += `<tr style="${rowStyle}">`;
            
            keys.forEach(key => {
                let displayValue = item[key];
                let type = 'text';

                if (key === 'valor') {
                    displayValue = formatCurrency(item.valor);
                    type = 'number';
                } else if (key === 'vencimento' || key === 'mes') {
                    type = 'number';
                } else if (key === 'percentual') {
                    const valueForPercent = item.recorrencia === 'Anual' ? 0 : item.valor;
                    const percent = (totalMonthlyExpenses > 0) ? (valueForPercent / totalMonthlyExpenses * 100) : 0;
                    displayValue = formatPercent(percent);
                    type = 'readonly';
                } else if (key === 'participacao_receita') {
                    const percent = (totalReceitas > 0) ? (item.valor / totalReceitas * 100) : 0;
                    displayValue = formatPercent(percent);
                    type = 'readonly';
                }

                html += `<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; ${key === 'valor' ? 'font-weight: bold;' : ''}">
                    <span 
                        ${type !== 'readonly' ? `onclick="makeEditable(this, ${item.id}, '${key}', '${type}')"` : ''}
                    >
                        ${displayValue}
                    </span>
                </td>`;
            });

            html += `<td style="padding: 8px; border-bottom: 1px solid #eee;">
                <button class="delete-btn" data-id="${item.id}" data-type="expense" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">X</button>
            </td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        tableDiv.innerHTML = html;
    }
    
    function sortTableBy(column) {
        if (column === currentSortColumn) {
            currentSortDirection *= -1; 
        } else {
            currentSortColumn = column;
            currentSortDirection = 1; 
        }
        processData(); 
    }

    // --- GR√ÅFICOS ---
    
    function renderMonthlyEvolutionChart() {
        const monthlyTotals = Array(12).fill(0);
        const monthlyPaid = Array(12).fill(0);

        rawData.forEach(d => {
            const monthIndex = d.mes - 1;
            const recurrence = String(d.recorrencia || '').toLowerCase().trim();
            
            if (recurrence !== 'anual') {
                monthlyTotals[monthIndex] += d.valor;
            }
            
            if (d.status === 'Pago') {
                monthlyPaid[monthIndex] += d.valor;
            }
        });

        const labels = MONTH_NAMES_SHORT.slice(0, 12); 

        const traceTotal = {
            x: labels, y: monthlyTotals, mode: 'lines+markers', type: 'scatter', name: 'Gasto Projetado',
            line: { color: '#dc3545', width: 2 }, hovertemplate: '<b>%{x}</b><br>Projetado: R$ %{y:,.2f}<extra></extra>'
        };

        const tracePaid = {
            x: labels, y: monthlyPaid, mode: 'lines+markers', type: 'scatter', name: 'Total Pago',
            line: { color: '#28a745', width: 2 }, hovertemplate: '<b>%{x}</b><br>Pago: R$ %{y:,.2f}<extra></extra>'
        };

        const layout = {
            title: false, height: 350,
            xaxis: { title: 'M√™s', tickvals: labels, ticktext: labels },
            yaxis: { title: 'Valor (R$)', tickformat: '$,.0f' },
            margin: { t: 20, b: 50, l: 60, r: 20 }, hovermode: 'x unified',
            legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: 1.15 }
        };
        Plotly.react('grafico-evolucao-mensal', [traceTotal, tracePaid], layout, {displayModeBar: false});
    }

    function renderEssencialChart(monthlyData) {
        const typeTotals = monthlyData.reduce((acc, d) => {
            const type = d.tipo_gasto;
            acc[type] = (acc[type] || 0) + d.valor;
            return acc;
        }, {});

        const labels = Object.keys(typeTotals);
        const values = Object.values(typeTotals);

        const chartData = [{
            values: values, labels: labels, type: 'pie', hole: .4, 
            marker: { colors: ['#dc3545', '#007bff'] }, 
            hovertemplate: '<b>%{label}</b><br>R$ %{value:,.2f}<br>Total: **%{percent}**<extra></extra>', 
            textinfo: 'percent', textposition: 'inside',
        }];

        const layout = { title: false, height: 300, margin: { t: 50, b: 0, l: 0, r: 0 } };

        Plotly.react('grafico-essencial', chartData, layout, {displayModeBar: false});
    }

    function renderPaymentMethodChart(monthlyData) {
        const methodTotals = monthlyData.reduce((acc, d) => {
            const method = d.cartao;
            acc[method] = (acc[method] || 0) + d.valor;
            return acc;
        }, {});

        const labels = Object.keys(methodTotals);
        const values = Object.values(methodTotals);

        const chartData = [{
            values: values, labels: labels, type: 'pie', hole: .4,
            hovertemplate: '<b>%{label}</b><br>R$ %{value:,.2f}<br>Total: **%{percent}**<extra></extra>', 
            textinfo: 'percent', textposition: 'inside',
        }];

        const layout = { title: false, height: 300, margin: { t: 50, b: 0, l: 0, r: 0 } };

        Plotly.react('grafico-pagamento', chartData, layout, {displayModeBar: false});
    }

    function renderCategoryProportionChart(monthlyData) {
        const categoryTotals = monthlyData.reduce((acc, d) => {
            const category = d.categoria;
            acc[category] = (acc[category] || 0) + d.valor;
            return acc;
        }, {});

        const sortedCategories = Object.entries(categoryTotals)
            .sort(([, a], [, b]) => b - a);

        const labels = sortedCategories.map(([category]) => category);
        const values = sortedCategories.map(([, total]) => total);

        const chartData = [{
            x: values, y: labels, type: 'bar', orientation: 'h',
            marker: { color: '#007bff' },
            hovertemplate: '<b>%{y}</b>: R$ %{x:,.2f}<extra></extra>'
        }];

        const layout = {
            title: false, height: Math.max(400, labels.length * 50), 
            margin: { l: 150, r: 20, t: 20, b: 50 },
            xaxis: { title: 'Valor (R$)', tickformat: '$,.0f' },
            yaxis: { autorange: 'reversed' } 
        };

        Plotly.react('grafico-categoria', chartData, layout, {displayModeBar: false});
    }

    // Gr√°fico de Distribui√ß√£o de Investimentos (Pizza - AGORA POR ATIVO)
    function renderInvestmentDistributionChart(monthlyInvestments, totalAcumulado) {
         // Agrupa por Tipo de Ativo em vez de Banco (para o gr√°fico de Pizza)
         const ativoTotals = rawInvestments
            .filter(i => parseInt(i.mes) === currentMonth)
            .reduce((acc, item) => {
                // Soma todos os aportes/acumulados no m√™s atual por tipo de ativo
                acc[item.tipo_ativo] = (acc[item.tipo_ativo] || 0) + item.valor_aplicado;
                return acc;
            }, {});
            
        // Se o m√™s atual n√£o tem dados, usa o √∫ltimo m√™s dispon√≠vel
        if (Object.keys(ativoTotals).length === 0 && rawInvestments.length > 0) {
            const lastAvailableMonth = rawInvestments.reduce((maxMonth, item) => Math.max(maxMonth, item.mes), 0);
            rawInvestments
                .filter(i => parseInt(i.mes) === lastAvailableMonth)
                .reduce((acc, item) => {
                    acc[item.tipo_ativo] = (acc[item.tipo_ativo] || 0) + item.valor_aplicado;
                    return acc;
                }, ativoTotals);
        }

        const labels = Object.keys(ativoTotals);
        const values = Object.values(ativoTotals);
        
        const colors = ['#007bff', '#28a745', '#9C27B0', '#ff9800', '#dc3545', '#17a2b8']; 

        const chartData = [{
            values: values, labels: labels, type: 'pie', hole: .4, 
            marker: { colors: colors },
            hovertemplate: '<b>%{label}</b><br>R$ %{value:,.2f}<br>Total: **%{percent}**<extra></extra>', 
            textinfo: 'percent', textposition: 'inside',
        }];

        const layout = { title: false, height: 300, margin: { t: 50, b: 0, l: 0, r: 0 } };

        Plotly.react('grafico-investimentos-distribuicao', chartData, layout, {displayModeBar: false});
    }
    
    function renderInvestmentEvolutionChart() {
        const monthlyAccumulated = rawInvestments.reduce((acc, row) => {
            const monthIndex = row.mes - 1; 
            const key = `${row.banco}_${row.tipo_ativo}`;
            
            if (!acc[monthIndex]) {
                acc[monthIndex] = {};
            }
            
            acc[monthIndex][key] = row.valor_aplicado;
            
            return acc;
        }, {});
        
        const monthlyTotals = Array(12).fill(0);
        
        for (let i = 0; i < 12; i++) {
            if (monthlyAccumulated[i] && Object.keys(monthlyAccumulated[i]).length > 0) {
                monthlyTotals[i] = Object.values(monthlyAccumulated[i]).reduce((sum, val) => sum + val, 0);
            } else if (i > 0) {
                monthlyTotals[i] = monthlyTotals[i - 1];
            }
        }

        const labels = MONTH_NAMES_SHORT.slice(0, 12); 

        const traceTotal = {
            x: labels, y: monthlyTotals, mode: 'lines+markers', type: 'scatter', name: 'Saldo Total Acumulado',
            line: { color: '#00a068', width: 3 }, 
            marker: { size: 10, color: '#00a068', line: { width: 1, color: 'white' } },
            hovertemplate: '<b>%{x}</b><br>Total Acumulado: R$ %{y:,.2f}<extra></extra>'
        };

        const layout = {
            title: false, height: 350,
            xaxis: { title: 'M√™s', tickvals: labels, ticktext: labels },
            yaxis: { title: 'Valor Acumulado (R$)', tickformat: '$,.0f' },
            margin: { t: 20, b: 50, l: 60, r: 20 }, hovermode: 'x unified',
            legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: 1.15 } 
        };

        Plotly.react('grafico-evolucao-investimentos', [traceTotal], layout, {displayModeBar: false});
    }

    // --- FUN√á√ïES DE EXPORTA√á√ÉO ---
    
    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function exportDataToCSV(dataArray, columnNames, month, filenamePrefix) {
        const dataFilteredByMonth = dataArray.filter(item => parseInt(item.mes) === month);

        const dataToExport = dataFilteredByMonth.map(item => {
            const row = {};
            for (const internalKey in columnNames) {
                const originalHeader = columnNames[internalKey];
                let value = item[internalKey];

                if (internalKey === 'valor' || internalKey === 'valor_aplicado' || internalKey === 'novo_aporte') {
                    value = String(value).replace('.', ','); 
                } else if (typeof value === 'string' && value.includes(';')) {
                    value = `"${value}"`;
                }
                row[originalHeader] = value;
            }
            return row;
        });

        const csv = Papa.unparse(dataToExport, { header: true, delimiter: ";", quotes: false });
        const monthStr = String(month).padStart(2, '0');
        const filename = `${monthStr}-${filenamePrefix}_${CURRENT_YEAR}.csv`;
        
        downloadCSV(csv, filename);
    }

    function exportExpensesToCSV(month) {
        exportDataToCSV(rawData, EXPENSE_COLUMN_NAMES, month, 'controle-gastos');
    }

    function exportRevenuesToCSV(month) {
        // Exporta Receitas e Aportes
        const revenueAndAporteColumns = {...REVENUE_COLUMN_NAMES};
        revenueAndAporteColumns['valor'] = 'Valor (R$)'; // Usa o nome original
        
        // Filtra para incluir receitas positivas e aportes negativos
        const dataToExport = rawRevenues.filter(r => parseInt(r.mes) === month);

        const dataMapped = dataToExport.map(item => {
            const row = {};
            for (const internalKey in revenueAndAporteColumns) {
                const originalHeader = revenueAndAporteColumns[internalKey];
                let value = item[internalKey];

                if (internalKey === 'valor') {
                    value = String(value).replace('.', ','); 
                } else if (typeof value === 'string' && value.includes(';')) {
                    value = `"${value}"`;
                }
                row[originalHeader] = value;
            }
            return row;
        });

        const csv = Papa.unparse(dataMapped, { header: true, delimiter: ";", quotes: false });
        const monthStr = String(month).padStart(2, '0');
        const filename = `${monthStr}-controle-receitas-e-aportes_${CURRENT_YEAR}.csv`;
        
        downloadCSV(csv, filename);
    }
    
    function exportInvestmentsToCSV(month) {
        exportDataToCSV(rawInvestments, INVESTMENT_COLUMN_NAMES, month, 'controle-investimentos');
    }

    function saveCurrentMonthData() {
        let exportedCount = 0;
        const monthName = MONTH_NAMES[currentMonth - 1]; 

        if (rawData.some(d => parseInt(d.mes) === currentMonth)) {
            exportExpensesToCSV(currentMonth);
            exportedCount++;
        }
        if (rawRevenues.some(r => parseInt(r.mes) === currentMonth)) {
            exportRevenuesToCSV(currentMonth);
            exportedCount++;
        }
        if (rawInvestments.some(i => parseInt(i.mes) === currentMonth)) {
            exportInvestmentsToCSV(currentMonth);
            exportedCount++;
        }
        
        alert(`Processo de exporta√ß√£o iniciado. ${exportedCount} arquivo(s) CSV (Despesas, Receitas e Investimentos) do m√™s de ${monthName} ser√£o enviados para download. Voc√™ deve aceitar os m√∫ltiplos downloads.`);
    }

    function saveAllData() { 
        let exportedCount = 0;
        
        for (let i = 1; i <= 12; i++) {
            if (rawData.some(d => parseInt(d.mes) === i)) {
                exportExpensesToCSV(i);
                exportedCount++;
            }
            // Exporta receitas e aportes do m√™s 'i'
            if (rawRevenues.some(r => parseInt(r.mes) === i)) {
                exportRevenuesToCSV(i);
                exportedCount++;
            }
            if (rawInvestments.some(item => parseInt(item.mes) === i)) {
                exportInvestmentsToCSV(i);
                exportedCount++;
            }
        }
        
        alert(`Processo de exporta√ß√£o iniciado. ${exportedCount} arquivos CSV (Despesas, Receitas/Aportes e Investimentos por M√™s) ser√£o enviados para download. Voc√™ deve aceitar os m√∫ltiplos downloads.`);
    }

    </script>
</body>
</html>